{% extends "templates/web.html" %}

{% block page_content %}
<div class="portal-wrapper">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>{{ title }}</h1>
        <div>
            {% if doc %}
            <button class="btn btn-danger me-2" onclick="deleteMember('{{ doc.name }}')">
                {{ _("Delete") }}
            </button>
            {% endif %}
            <a href="/my-portal/members" class="btn btn-secondary">{{ _("Back to List") }}</a>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <form id="memberForm">
                <input type="hidden" name="doctype" value="Member">
                {% if doc %}
                <input type="hidden" name="name" value="{{ doc.name }}">
                {% endif %}

                <div class="row g-3">
                    <!-- Personal Information -->
                    <div class="col-md-6">
                        <label class="form-label">{{ _("Full Name") }} *</label>
                        <input type="text" class="form-control" name="full_name" 
                               value="{{ doc.full_name if doc else '' }}" required>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">{{ _("Email") }}</label>
                        <input type="email" class="form-control" name="email" 
                               value="{{ doc.email if doc else '' }}">
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">{{ _("Phone") }}</label>
                        <input type="tel" class="form-control" name="phone" 
                               value="{{ doc.phone if doc else '' }}">
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">{{ _("Status") }}</label>
                        <select class="form-select" name="status">
                            {% set status_options = ['Active', 'Inactive', 'Pending'] %}
                            {% for status in status_options %}
                            <option value="{{ status }}" 
                                    {% if doc and doc.status == status %}selected{% endif %}>
                                {{ _(status) }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Address Information -->
                    <div class="col-12">
                        <label class="form-label">{{ _("Address") }}</label>
                        <textarea class="form-control" name="address" rows="3">{{ doc.address if doc else '' }}</textarea>
                    </div>

                    <div class="col-12 mt-4">
                        <button type="submit" class="btn btn-primary">
                            {{ _("Save Changes") }}
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
frappe.ready(function() {
    $('#memberForm').on('submit', function(e) {
        e.preventDefault();
        
        const formData = {};
        $(this).serializeArray().forEach(item => {
            formData[item.name] = item.value;
        });

        frappe.call({
            method: 'umt_nfe.www.my-portal.member.index.save_member',
            args: {
                data: formData
            },
            callback: function(r) {
                if (!r.exc) {
                    frappe.show_alert({
                        message: __('Member saved successfully'),
                        indicator: 'green'
                    });
                    setTimeout(() => {
                        window.location.href = '/my-portal/members';
                    }, 1000);
                }
            }
        });
    });
});

function deleteMember(name) {
    frappe.confirm(
        __('Are you sure you want to delete this member?'),
        function() {
            frappe.call({
                method: 'umt_nfe.www.my-portal.member.index.delete_member',
                args: {
                    member_name: name
                },
                callback: function(r) {
                    if (!r.exc) {
                        frappe.show_alert({
                            message: __('Member deleted successfully'),
                            indicator: 'green'
                        });
                        setTimeout(() => {
                            window.location.href = '/my-portal/members';
                        }, 1000);
                    }
                }
            });
        }
    );
}
</script>
{% endblock %}

{% block style %}
<style>
.portal-wrapper {
    padding: 2rem;
}
.form-label {
    font-weight: 500;
}
</style>
{% endblock %}
